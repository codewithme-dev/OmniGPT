<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universal AI - Vision & Voice</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gptDark: '#343541',
                        gptSidebar: '#202123',
                        gptInput: '#40414F',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }
        .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        .markdown-body pre { background: #1a1b1e; padding: 1rem; border-radius: 8px; overflow-x: auto; }
        .typing-dot { animation: jump 1s infinite; }
        @keyframes jump { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        /* Video Pulse */
        .listening-ring {
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
            animation: pulse-blue 2s infinite;
        }
        @keyframes pulse-blue {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="bg-white dark:bg-gptDark text-gray-800 dark:text-gray-100 font-sans transition-colors duration-200 overflow-hidden">

    <div id="app" class="flex h-[100dvh] relative">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-black/95 dark:bg-gptSidebar transform -translate-x-full md:translate-x-0 transition-transform duration-300 flex flex-col border-r border-white/10">
            <div class="p-4">
                <button onclick="createNewChat()" class="w-full flex items-center gap-3 px-4 py-3 border border-white/20 rounded-lg hover:bg-white/10 text-white text-sm transition-all">
                    <i class="fa-solid fa-plus"></i> New Chat
                </button>
            </div>
            <div class="flex-1 overflow-y-auto px-2" id="history-list"></div>
            <div class="p-4 border-t border-white/10 text-white text-sm space-y-2">
                <button onclick="toggleSettings()" class="flex items-center gap-3 w-full px-3 py-3 hover:bg-white/10 rounded-lg">
                    <i class="fa-solid fa-gear"></i> Settings
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col md:ml-64 relative h-full">
            
            <header class="flex items-center justify-between px-4 py-3 border-b border-gray-200 dark:border-white/10 bg-white dark:bg-gptDark z-10">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-500 dark:text-gray-300">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <div class="flex flex-col">
                        <span id="model-display" class="font-bold text-sm">Universal AI</span>
                        <span class="text-[10px] text-gray-400">Vision & Voice Enabled</span>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="toggleVideoMode()" class="text-gray-500 hover:text-blue-500 dark:text-gray-300 transition-colors" title="Live Video Mode">
                        <i class="fa-solid fa-video text-lg"></i>
                    </button>
                    <button onclick="toggleTheme()" class="text-gray-500 dark:text-gray-300">
                        <i id="theme-icon" class="fa-solid fa-moon"></i>
                    </button>
                </div>
            </header>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 pb-40 scroll-smooth">
                <div id="welcome-screen" class="h-full flex flex-col items-center justify-center text-center opacity-70">
                    <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mb-6 shadow-lg">
                        <i class="fa-solid fa-sparkles text-2xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-2">How can I help you?</h2>
                    <p class="text-sm mb-8">Generate images, analyze photos, or automate tasks.</p>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 w-full max-w-2xl px-4">
                        <button onclick="setInput('Generate an image of a neon city')" class="p-4 border border-gray-200 dark:border-white/20 rounded-xl text-left hover:bg-gray-50 dark:hover:bg-white/5 text-sm transition-colors">
                            <i class="fa-solid fa-image text-purple-500 mr-2"></i> Create an image of a neon city
                        </button>
                        <button onclick="setInput('Analyze this image')" class="p-4 border border-gray-200 dark:border-white/20 rounded-xl text-left hover:bg-gray-50 dark:hover:bg-white/5 text-sm transition-colors">
                            <i class="fa-solid fa-eye text-blue-500 mr-2"></i> Upload & Analyze a photo
                        </button>
                        <button onclick="setInput('Download VS Code')" class="p-4 border border-gray-200 dark:border-white/20 rounded-xl text-left hover:bg-gray-50 dark:hover:bg-white/5 text-sm transition-colors">
                            <i class="fa-solid fa-download text-green-500 mr-2"></i> Automation: Download VS Code
                        </button>
                        <button onclick="setInput('Open YouTube')" class="p-4 border border-gray-200 dark:border-white/20 rounded-xl text-left hover:bg-gray-50 dark:hover:bg-white/5 text-sm transition-colors">
                            <i class="fa-brands fa-youtube text-red-500 mr-2"></i> Automation: Open YouTube
                        </button>
                    </div>
                </div>
                <div id="messages-list" class="max-w-3xl mx-auto space-y-6 pb-4"></div>
            </div>

            <div class="absolute bottom-0 left-0 right-0 bg-white/90 dark:bg-gptDark/90 backdrop-blur-sm pt-2 pb-6 px-4 z-20 border-t border-transparent dark:border-white/5">
                <div class="max-w-3xl mx-auto">
                    <div id="attachment-preview" class="hidden mb-3 p-2 bg-gray-100 dark:bg-gray-700 rounded-lg inline-flex items-center gap-3 relative group">
                        <img id="img-preview" class="h-12 w-12 object-cover rounded-md hidden">
                        <div id="file-info" class="text-xs truncate max-w-[150px]"></div>
                        <button onclick="clearAttachment()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md"><i class="fa-solid fa-times"></i></button>
                    </div>

                    <div class="relative flex items-end w-full p-2 bg-white dark:bg-gptInput border border-gray-300 dark:border-black/20 rounded-2xl shadow-lg focus-within:ring-2 focus-within:ring-blue-500 transition-shadow">
                        <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-400 hover:text-blue-500 transition-colors" title="Upload Image/File">
                            <i class="fa-solid fa-paperclip text-xl"></i>
                        </button>
                        <input type="file" id="file-upload" class="hidden" accept="image/*,.txt,.js,.py,.html,.json,.md" onchange="handleFile(this)">

                        <textarea id="user-input" rows="1" class="w-full max-h-32 bg-transparent border-0 focus:ring-0 resize-none py-3 px-2 text-base dark:text-white dark:placeholder-gray-400" placeholder="Message Universal AI..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                        
                        <button id="send-btn" onclick="sendMessage()" class="p-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700 disabled:opacity-50 transition-colors shadow-md">
                            <i class="fa-solid fa-arrow-up"></i>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gptSidebar w-full max-w-md rounded-2xl shadow-2xl p-6 m-4 animate-fadeIn">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-uppercase text-gray-500 mb-1">OpenRouter API Key</label>
                    <input type="password" id="api-key" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 focus:border-blue-500 outline-none transition-all" placeholder="sk-or-...">
                </div>
                <div>
                    <label class="block text-xs font-uppercase text-gray-500 mb-1">Model (Supports Vision: google/gemini-pro-vision)</label>
                    <input type="text" id="model-id" class="w-full p-3 rounded-lg bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 outline-none" placeholder="google/gemini-2.0-flash-exp:free">
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button onclick="toggleSettings()" class="px-4 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-white/5">Cancel</button>
                <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
            </div>
        </div>
    </div>

    <div id="video-overlay" class="fixed inset-0 z-50 bg-black hidden flex flex-col items-center justify-center">
        <button onclick="toggleVideoMode()" class="absolute top-6 right-6 z-50 bg-gray-800/50 p-4 rounded-full text-white hover:bg-red-600 transition-colors backdrop-blur-md">
            <i class="fa-solid fa-xmark text-xl"></i>
        </button>

        <div class="relative w-full h-full flex flex-col items-center justify-center">
            
            <video id="live-video" autoplay muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-50"></video>
            
            <div class="relative z-10 flex flex-col items-center">
                <div id="ai-status-orb" class="w-32 h-32 rounded-full bg-white/10 backdrop-blur-xl border border-white/20 flex items-center justify-center shadow-[0_0_50px_rgba(59,130,246,0.5)] transition-all duration-300">
                    <i class="fa-solid fa-microphone text-4xl text-white"></i>
                </div>
                <p id="voice-status" class="mt-8 text-white text-xl font-light tracking-wide animate-pulse">Listening...</p>
                <div id="voice-response-text" class="mt-4 px-6 py-2 bg-black/50 rounded-lg text-white/90 max-w-md text-center text-sm hidden"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DEFAULT_MODEL = "google/gemini-2.0-flash-exp:free"; // Good for free vision
        let state = {
            apiKey: localStorage.getItem("gpt_key") || "",
            model: localStorage.getItem("gpt_model") || DEFAULT_MODEL,
            chats: JSON.parse(localStorage.getItem("gpt_chats") || "[]"),
            currentChatId: null,
            attachment: null, // { type: 'image'|'text', content: 'base64', name: '' }
            isListening: false
        };

        // --- DOM ELEMENTS ---
        const els = {
            input: document.getElementById('user-input'),
            chatList: document.getElementById('messages-list'),
            preview: document.getElementById('attachment-preview'),
            imgPreview: document.getElementById('img-preview'),
            fileInfo: document.getElementById('file-info'),
            videoOverlay: document.getElementById('video-overlay'),
            video: document.getElementById('live-video'),
            orb: document.getElementById('ai-status-orb'),
            statusText: document.getElementById('voice-status'),
            subtitle: document.getElementById('voice-response-text')
        };

        // --- INIT ---
        window.onload = () => {
            const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if(isDark) document.documentElement.classList.add('dark');
            
            if (state.chats.length === 0) createNewChat();
            else loadChat(state.chats[0].id);
            renderHistory();
        };

        // --- CORE CHAT LOGIC ---
        function createNewChat() {
            const chat = { id: Date.now().toString(), title: "New Chat", messages: [] };
            state.chats.unshift(chat);
            loadChat(chat.id);
            saveChats();
        }

        function loadChat(id) {
            state.currentChatId = id;
            const chat = state.chats.find(c => c.id === id);
            els.chatList.innerHTML = '';
            document.getElementById('welcome-screen').classList.toggle('hidden', chat.messages.length > 0);
            chat.messages.forEach(msg => appendMessageToUI(msg));
            renderHistory();
            if(window.innerWidth < 768) document.getElementById('sidebar').classList.add('-translate-x-full');
        }

        async function sendMessage(overrideText = null) {
            const text = overrideText || els.input.value.trim();
            if (!text && !state.attachment) return;

            if (!state.apiKey) {
                toggleSettings();
                alert("Please enter OpenRouter API Key first (Free keys available at openrouter.ai)");
                return;
            }

            // 1. UI Updates
            els.input.value = '';
            els.input.style.height = 'auto';
            document.getElementById('welcome-screen').classList.add('hidden');
            
            // 2. Client Side Automation & Tools
            const automationResult = checkTools(text);
            if (automationResult) {
                // If tool handled it (like Image Gen), just show user msg and return
                appendMessageToUI({ role: 'user', content: text });
                saveMsg({ role: 'user', content: text });
                
                setTimeout(() => {
                    appendMessageToUI({ role: 'assistant', content: automationResult });
                    saveMsg({ role: 'assistant', content: automationResult });
                }, 600);
                
                clearAttachment();
                return;
            }

            // 3. Prepare Payload (Multimodal)
            let contentPayload = text;
            let displayContent = text;

            if (state.attachment) {
                if (state.attachment.type === 'image') {
                    // Vision Payload
                    contentPayload = [
                        { type: "text", text: text || "Describe this image" },
                        { type: "image_url", image_url: { url: state.attachment.content } }
                    ];
                    displayContent = `![Uploaded Image](${state.attachment.content})\n\n${text}`;
                } else {
                    // Text File Payload
                    const fileMsg = `\n\n[File: ${state.attachment.name}]\n\`\`\`\n${state.attachment.content}\n\`\`\``;
                    contentPayload = text + fileMsg;
                    displayContent = text + fileMsg;
                }
            }

            const userMsg = { role: 'user', content: displayContent }; // Stored for history
            appendMessageToUI(userMsg);
            saveMsg(userMsg);

            // 4. API Request
            const tempId = 'ai-' + Date.now();
            appendLoadingIndicator(tempId);
            clearAttachment();

            try {
                // Construct full history for API context (Limit to last 10 to save tokens)
                const currentChat = state.chats.find(c => c.id === state.currentChatId);
                const apiMessages = currentChat.messages.slice(-10).map(m => {
                    // Convert history back to API format if needed (simplified here)
                    return { role: m.role, content: m.content };
                });

                // Replace last message with the properly formatted payload
                apiMessages[apiMessages.length - 1] = { role: 'user', content: contentPayload };

                const resp = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                    },
                    body: JSON.stringify({
                        model: state.model,
                        messages: apiMessages,
                        stream: true
                    })
                });

                const reader = resp.body.getReader();
                const decoder = new TextDecoder();
                let fullText = "";
                const responseDiv = document.getElementById(tempId).querySelector('.markdown-body');
                document.getElementById(tempId).querySelector('.typing-dot').remove();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');
                    for (const line of lines) {
                        if (line.startsWith('data: ') && line !== 'data: [DONE]') {
                            try {
                                const json = JSON.parse(line.slice(6));
                                const delta = json.choices[0]?.delta?.content || "";
                                fullText += delta;
                                responseDiv.innerHTML = marked.parse(fullText);
                            } catch(e){}
                        }
                    }
                }
                
                // Highlight code blocks
                hljs.highlightAll();
                saveMsg({ role: 'assistant', content: fullText });
                
                // If in video mode, speak it
                if (!els.videoOverlay.classList.contains('hidden')) {
                    speakText(fullText);
                }

            } catch (err) {
                document.getElementById(tempId).innerHTML = `<div class="text-red-500">Error: ${err.message}</div>`;
            }
        }

        // --- TOOLS & AUTOMATION ---
        function checkTools(text) {
            const lower = text.toLowerCase();
            
            // 1. IMAGE GENERATION (Pollinations.ai)
            if (lower.includes("generate image") || lower.includes("create image") || lower.includes("draw")) {
                const prompt = text.replace(/generate image|create image|draw/gi, "").trim();
                const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=1024&nologo=true&seed=${Math.random()}`;
                return `Here is your image for "${prompt}":\n\n![Generated Image](${imgUrl})`;
            }

            // 2. DOWNLOAD AUTOMATION
            if (lower.includes("download") && (lower.includes("vs code") || lower.includes("software"))) {
                setTimeout(() => {
                    const a = document.createElement('a');
                    a.href = "data:text/plain,Simulated Installer";
                    a.download = "VSCode_Setup_Mock.exe";
                    a.click();
                }, 1000);
                return "Initializing download for Visual Studio Code... Check your downloads folder.";
            }

            // 3. OPEN WEBSITE
            if (lower.startsWith("open ")) {
                const site = lower.replace("open ", "").trim();
                let url = site.includes(".") ? "https://" + site : "https://www.google.com/search?q=" + site;
                if(site.includes("youtube")) url = "https://www.youtube.com";
                setTimeout(() => window.open(url, '_blank'), 1000);
                return `Opening ${site}...`;
            }

            return null;
        }

        // --- ATTACHMENT HANDLING ---
        function handleFile(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const isImage = file.type.startsWith('image/');
                state.attachment = {
                    type: isImage ? 'image' : 'text',
                    content: e.target.result, // DataURL
                    name: file.name
                };

                // UI Update
                els.preview.classList.remove('hidden');
                els.preview.classList.add('flex');
                els.fileInfo.textContent = file.name;
                
                if (isImage) {
                    els.imgPreview.src = e.target.result;
                    els.imgPreview.classList.remove('hidden');
                } else {
                    els.imgPreview.classList.add('hidden');
                }
            };
            
            if (file.type.startsWith('image/')) reader.readAsDataURL(file);
            else reader.readAsText(file);
        }

        function clearAttachment() {
            state.attachment = null;
            els.preview.classList.add('hidden');
            els.preview.classList.remove('flex');
            document.getElementById('file-upload').value = '';
        }

        // --- VIDEO / VOICE MODE ---
        let recognition;
        
        function toggleVideoMode() {
            const overlay = els.videoOverlay;
            const isHidden = overlay.classList.contains('hidden');

            if (isHidden) {
                // START MODE
                overlay.classList.remove('hidden');
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(stream => els.video.srcObject = stream)
                    .catch(e => console.error("Camera error", e));
                
                startListening();
            } else {
                // STOP MODE
                overlay.classList.add('hidden');
                const stream = els.video.srcObject;
                if(stream) stream.getTracks().forEach(t => t.stop());
                stopListening();
                window.speechSynthesis.cancel();
            }
        }

        function startListening() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Speech recognition not supported in this browser.");
                return;
            }
            
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            recognition.onstart = () => {
                els.orb.classList.add('listening-ring');
                els.statusText.innerText = "Listening...";
            };

            recognition.onend = () => {
                els.orb.classList.remove('listening-ring');
                // If we are still in video mode and not speaking, restart listening
                if (!els.videoOverlay.classList.contains('hidden') && !window.speechSynthesis.speaking) {
                    // Slight delay to prevent instant loop
                    // setTimeout(() => recognition.start(), 1000);
                    els.statusText.innerText = "Tap to speak again (Auto-loop disabled for safety)";
                }
            };

            recognition.onresult = (event) => {
                const text = event.results[0][0].transcript;
                els.statusText.innerText = "Thinking...";
                sendMessage(text);
            };

            recognition.start();
        }

        function stopListening() {
            if(recognition) recognition.stop();
        }

        function speakText(text) {
            window.speechSynthesis.cancel();
            
            // Clean markdown for speech
            const cleanText = text.replace(/[*#`\[\]]/g, '');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            utterance.onstart = () => {
                els.orb.classList.add('animate-pulse', 'bg-blue-500');
                els.statusText.innerText = "Speaking...";
                els.subtitle.classList.remove('hidden');
                els.subtitle.innerText = cleanText.substring(0, 100) + "...";
            };

            utterance.onend = () => {
                els.orb.classList.remove('animate-pulse', 'bg-blue-500');
                els.subtitle.classList.add('hidden');
                // Resume listening after speaking
                if(!els.videoOverlay.classList.contains('hidden')) startListening();
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- HELPER FUNCTIONS ---
        function appendMessageToUI(msg) {
            const div = document.createElement('div');
            const isUser = msg.role === 'user';
            div.className = `flex gap-4 ${isUser ? 'flex-row-reverse' : ''}`;
            
            const avatar = isUser 
                ? `<div class="w-8 h-8 rounded bg-gray-200 dark:bg-gray-600 flex items-center justify-center shrink-0"><i class="fa-solid fa-user"></i></div>`
                : `<div class="w-8 h-8 rounded bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center shrink-0 text-white"><i class="fa-solid fa-robot"></i></div>`;

            div.innerHTML = `
                ${avatar}
                <div class="max-w-[85%] ${isUser ? 'bg-gray-100 dark:bg-[#444654] rounded-2xl rounded-tr-sm px-4 py-2' : 'w-full'}">
                    <div class="markdown-body prose dark:prose-invert text-sm">${marked.parse(msg.content)}</div>
                </div>
            `;
            els.chatList.appendChild(div);
            scrollToBottom();
        }

        function appendLoadingIndicator(id) {
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex gap-4";
            div.innerHTML = `
                <div class="w-8 h-8 rounded bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center shrink-0 text-white"><i class="fa-solid fa-robot"></i></div>
                <div class="flex items-center"><div class="typing-dot w-2 h-2 bg-gray-400 rounded-full"></div></div>
                <div class="markdown-body prose dark:prose-invert text-sm w-full"></div>
            `;
            els.chatList.appendChild(div);
            scrollToBottom();
        }

        function saveMsg(msg) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            chat.messages.push(msg);
            saveChats();
        }

        function saveChats() {
            localStorage.setItem("gpt_chats", JSON.stringify(state.chats));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = state.chats.map(c => `
                <div onclick="loadChat('${c.id}')" class="p-3 rounded-lg cursor-pointer hover:bg-white/10 text-gray-300 text-sm truncate ${c.id === state.currentChatId ? 'bg-white/10 text-white' : ''}">
                    ${c.messages[0]?.content.substring(0, 30) || "Empty Chat"}
                </div>
            `).join('');
        }

        function setInput(txt) {
            els.input.value = txt;
            els.input.focus();
        }

        function toggleSettings() {
            const m = document.getElementById('settings-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('api-key').value = state.apiKey;
                document.getElementById('model-id').value = state.model;
            }
        }

        function saveSettings() {
            state.apiKey = document.getElementById('api-key').value;
            state.model = document.getElementById('model-id').value;
            localStorage.setItem("gpt_key", state.apiKey);
            localStorage.setItem("gpt_model", state.model);
            toggleSettings();
        }

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        function autoResize(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function handleEnter(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function scrollToBottom() {
            const c = document.getElementById('chat-container');
            c.scrollTop = c.scrollHeight;
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            sb.classList.toggle('-translate-x-full');
        }
    </script>
</body>
</html>
